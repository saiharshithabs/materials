name: SonarCloud Scan

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    name: Run SonarCloud Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # required for better analysis

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=saiharshithabs_materials
            -Dsonar.organization=saiharshithabs
            -Dsonar.exclusions=**/*.java
            -Dsonar.c.file.suffixes=-
            -Dsonar.cpp.file.suffixes=-
            -Dsonar.objc.file.suffixes=-


         
  cpp-check:
    name: Cppcheck Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Cppcheck
        run: sudo apt-get update && sudo apt-get install -y cppcheck
      - name: Run Cppcheck
        run: cppcheck --enable=all --inconclusive --quiet .     
            
      
  java-pmd:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download PMD
      run: |
        curl -L -o pmd.zip https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.19.0/pmd-dist-7.19.0-bin.zip
        unzip pmd.zip

    - name: Run PMD Quality Scan
      run: |
        ./pmd-bin-7.19.0/bin/pmd check \
          --dir src \
          --rulesets category/java/bestpractices.xml,category/java/errorprone.xml


  grype:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Grype
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh

    - name: Run Grype
      run: |
        ./bin/grype dir:. \
          --exclude "./.github/**" \
          --fail-on high
